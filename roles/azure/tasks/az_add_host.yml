---

- name: Get facts for network interfaces
  azure_rm_networkinterface_facts:
    resource_group: "{{ az_resourcegroup_name }}"
    name: "nic-{{ az_scope }}-{{ item }}"
  with_sequence: count="{{az_count}}" 
  register: nics

- set_fact:
    ips_to_add: "{{ nics | json_query('results[*].ansible_facts.azure_networkinterfaces[*].properties.ipConfigurations[*].properties.privateIPAddress') }}  "

- debug: 
    var: ips_to_add

# - set_fact:
#     networkinterfaces: []
#     ips_to_add: []

# - name: Extract azure_networkinterfaces
#   vars:
#     iterator:  "{{ item.ansible_facts.azure_networkinterfaces }}"
#   set_fact:
#     networkinterfaces:  "{{ networkinterfaces + iterator  }}"
#   loop:  "{{ nics.results }}"

# - name:  Extract privateIPAddress
#   vars:
#     iterator:  "{{ item.properties.ipConfigurations.0.properties.privateIPAddress }}"
#     iterator_list: [ '{{ iterator }}' ]
#   set_fact:
#     ips_to_add: "{{ ips_to_add +  iterator_list }}"
#   loop:  "{{ networkinterfaces }}"


- name: Add hosts
  add_host:
    name: "{{ item }}"
    groups: "{{ az_scope }}"
  with_items: "{{ ips_to_add }}" 

- name: Wait for SSH to come up
  wait_for_connection:
    timeout: 600
    sleep: 15
  delegate_to: "{{ item }}"
  with_items: "{{ ips_to_add }}"